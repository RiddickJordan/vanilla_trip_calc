<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Trip Reimbursement</title>
  </head>
  <body>
    <main>
        <h1>Trip Reimbursement Calculator</h1>
         <form onsubmit="handleSubmit(event)">
            <fieldset>
                <legend>Travel History</legend>
                <ol></ol>
                <button onclick="addTrip()" type="button">Add Another Trip</button>
                <br />
                <input type="submit" value="Calclulate Reimbursement" />
                <br />
                <button onclick="clearTrips()" type="button">Clear All Trips</button>
            </fieldset>
        </form>
        <article>
            <h2>Reimbursement Total</h2>
            <span>Enter your travel history and use the 'Calculate Reimbursement' button and the total will appear here.</span>
        </article>
    </main>
    <script type="text/javascript">
        

        const calcReimursement = (trips) => {
            const days = new Set();
            const highDays = new Set();
            let cost = 0;

            for(trip in trips){
                const thisTrip = trips[trip];
                const start = new Date(thisTrip.start);
                const end = new Date(thisTrip.end);

                if(start <= end){
                    const date = new Date(start.getTime());
                    const dates = [];

                    while (date <= end) {
                        days.add(new Date(date).toString());
                        if(thisTrip.cost == 'on'){
                            highDays.add(new Date(date).toString());
                        }
                        date.setDate(date.getDate() + 1);
                    }
                }
            }

            for (const day of days) {
                const thisDay = new Date(day);
                const previousDay = new Date(thisDay.getTime())
                previousDay.setDate(previousDay.getDate() - 1);
                
                const nextDay = new Date(thisDay.getTime())
                nextDay.setDate(nextDay.getDate() + 1);

                const dayBefore = days.has(previousDay.toString());
                const dayAfter = days.has(nextDay.toString());
                const highCost = highDays.has(day.toString());
                if (!dayBefore || !dayAfter){
                    cost += highCost ? 55 : 45;
                } else {
                    cost += highCost ? 85 : 75;
                }
            }
           return cost;
        }
        const handleSubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            const formDataObj = {};
            formData.forEach((value, key) => {
                const tripName = key.split('_')[0];
                const tripDetail = key.split('_')[1];
                if(!formDataObj[tripName]){
                    formDataObj[tripName] = {};
                }
                formDataObj[tripName][tripDetail] = value;
            })
            const compTotal = calcReimursement(formDataObj);
            document.querySelector('article span').innerText = compTotal > 0 ? `Reimbursement total is ${compTotal}`: "Caclulation Error. Please confirm data entry.";
        }

        const travelList = document.querySelector('ol');
        let tripIndex = 0;
        const addTrip = () => {
            tripIndex ++;
            const travelInputTemplate = `
                <label>
                    Start Date
                    <input type="date" name="trip${tripIndex}_start"/>
                </label>
                <label>
                    End Date
                    <input type="date" name="trip${tripIndex}_end"/>
                </label>
                <label>
                    High Cost City? 
                    <input type="checkbox" name="trip${tripIndex}_cost">
                </label>
                <button type="button" onclick="removeTrip(event)">Remove Trip</button>`;
            let li = document.createElement('li');
            li.innerHTML = travelInputTemplate;
            travelList.appendChild(li).querySelector('input').focus();
        }
        const clearTrips = () => {
            travelList.innerHTML = "";
        }
        const removeTrip = (e) => {
            travelList.removeChild(e.target.parentNode)
        }
        addTrip();
    </script>
  </body>
</html>